l_recv=lag(pos_RECV),
l_pblk=lag(pos_PBLK),
l_run=lag(pos_RUN),
l_rblk=lag(pos_RBLK)) %>%
#filter(!is.na(l_pass)) %>%
group_by(season,posteam.x) %>%
mutate(
cum_pass_grade = zoo::rollmean(pos_PASS,3,fill = NA ),
cum_recv_grade = cummean(l_recv),
cum_pblk_grade = cummean(l_pblk),
cum_run_grade = cummean(l_run,3),
cum_rblk_grade = cummean(l_rblk,3)
) %>% ungroup() %>%
mutate(
posid2 = paste0(season,week,posteam.x)
) %>% select(posid2,cum_pass_grade,cum_recv_grade,cum_pblk_grade,cum_run_grade,cum_rblk_grade)
#pos_cum<-
data %>% group_by(
season,week,posteam.x
) %>% summarise(
posteam.x = unique(posteam.x),
pos_PASS = unique(pos_PASS),
pos_RECV = unique(pos_RECV),
pos_PBLK = unique(pos_PBLK),
pos_RUN = unique(pos_RUN),
pos_RBLK = unique(pos_RBLK)
)%>% arrange(season,posteam.x,week) %>% ungroup() %>%
group_by(season,posteam.x) %>%
ungroup() %>%
mutate(
l_pass=lag(pos_PASS),
l_recv=lag(pos_RECV),
l_pblk=lag(pos_PBLK),
l_run=lag(pos_RUN),
l_rblk=lag(pos_RBLK)) %>%
#filter(!is.na(l_pass)) %>%
group_by(season,posteam.x) %>%
mutate(
cum_pass_grade = zoo::rollmean(pos_PASS,3,fill = NA ),
cum_recv_grade = cummean(l_recv),
cum_pblk_grade = cummean(l_pblk),
cum_run_grade = cummean(l_run,3),
cum_rblk_grade = cummean(l_rblk,3)
) %>% ungroup() %>%
mutate(
posid2 = paste0(season,week,posteam.x)
) %>% select(posid2,cum_pass_grade,cum_recv_grade,cum_pblk_grade,cum_run_grade,cum_rblk_grade)
#pos_cum<-
data %>% group_by(
season,week,posteam.x
) %>% summarise(
posteam.x = unique(posteam.x),
pos_PASS = unique(pos_PASS),
pos_RECV = unique(pos_RECV),
pos_PBLK = unique(pos_PBLK),
pos_RUN = unique(pos_RUN),
pos_RBLK = unique(pos_RBLK)
)%>% arrange(season,posteam.x,week) %>% ungroup() %>%
group_by(season,posteam.x) %>%
ungroup() %>%
mutate(
l_pass=lag(pos_PASS),
l_recv=lag(pos_RECV),
l_pblk=lag(pos_PBLK),
l_run=lag(pos_RUN),
l_rblk=lag(pos_RBLK)) %>%
#filter(!is.na(l_pass)) %>%
group_by(season,posteam.x) %>%
mutate(
cum_pass_grade = zoo::rollmean(pos_PASS,3,fill = NA ),
cum_recv_grade = cummean(l_recv),
cum_pblk_grade = cummean(l_pblk),
cum_run_grade = cummean(l_run),
cum_rblk_grade = cummean(l_rblk)
) %>% ungroup() %>%
mutate(
posid2 = paste0(season,week,posteam.x)
) %>% select(posid2,cum_pass_grade,cum_recv_grade,cum_pblk_grade,cum_run_grade,cum_rblk_grade)
#pos_cum<-
data %>% group_by(
season,week,posteam.x
) %>% summarise(
posteam.x = unique(posteam.x),
pos_PASS = unique(pos_PASS),
pos_RECV = unique(pos_RECV),
pos_PBLK = unique(pos_PBLK),
pos_RUN = unique(pos_RUN),
pos_RBLK = unique(pos_RBLK)
)%>% arrange(season,posteam.x,week) %>% ungroup() %>%
group_by(season,posteam.x) %>%
ungroup() %>%
mutate(
l_pass=lag(pos_PASS),
l_recv=lag(pos_RECV),
l_pblk=lag(pos_PBLK),
l_run=lag(pos_RUN),
l_rblk=lag(pos_RBLK)) %>%
#filter(!is.na(l_pass)) %>%
group_by(season,posteam.x) %>%
mutate(
cum_pass_grade = zoo::rollmean(pos_PASS,3,fill = NA ),
cum_recv_grade = cummean(l_recv),
cum_pblk_grade = cummean(l_pblk),
cum_run_grade = cummean(l_run),
cum_rblk_grade = cummean(l_rblk)
) %>% ungroup() %>%
mutate(
posid2 = paste0(season,week,posteam.x)
) %>%  #select(posid2,cum_pass_grade,cum_recv_grade,cum_pblk_grade,cum_run_grade,cum_rblk_grade)
select(posid2,posteam.x,pos_PASS,cum_pass_grade)
#pos_cum<-
data %>% group_by(
season,week,posteam.x
) %>% summarise(
posteam.x = unique(posteam.x),
pos_PASS = unique(pos_PASS),
pos_RECV = unique(pos_RECV),
pos_PBLK = unique(pos_PBLK),
pos_RUN = unique(pos_RUN),
pos_RBLK = unique(pos_RBLK)
)%>% arrange(season,posteam.x,week) %>% ungroup() %>%
group_by(season,posteam.x) %>%
ungroup() %>%
mutate(
l_pass=lag(pos_PASS),
l_recv=lag(pos_RECV),
l_pblk=lag(pos_PBLK),
l_run=lag(pos_RUN),
l_rblk=lag(pos_RBLK)) %>%
#filter(!is.na(l_pass)) %>%
group_by(season,posteam.x) %>%
mutate(
cum_pass_grade = zoo::rollmean(pos_PASS,1,fill = NA ),
cum_recv_grade = cummean(l_recv),
cum_pblk_grade = cummean(l_pblk),
cum_run_grade = cummean(l_run),
cum_rblk_grade = cummean(l_rblk)
) %>% ungroup() %>%
mutate(
posid2 = paste0(season,week,posteam.x)
) %>%  #select(posid2,cum_pass_grade,cum_recv_grade,cum_pblk_grade,cum_run_grade,cum_rblk_grade)
select(posid2,posteam.x,pos_PASS,cum_pass_grade)
#pos_cum<-
data %>% group_by(
season,week,posteam.x
) %>% summarise(
posteam.x = unique(posteam.x),
pos_PASS = unique(pos_PASS),
pos_RECV = unique(pos_RECV),
pos_PBLK = unique(pos_PBLK),
pos_RUN = unique(pos_RUN),
pos_RBLK = unique(pos_RBLK)
)%>% arrange(season,posteam.x,week) %>% ungroup() %>%
group_by(season,posteam.x) %>%
ungroup() %>%
mutate(
l_pass=lag(pos_PASS),
l_recv=lag(pos_RECV),
l_pblk=lag(pos_PBLK),
l_run=lag(pos_RUN),
l_rblk=lag(pos_RBLK)) %>%
#filter(!is.na(l_pass)) %>%
group_by(season,posteam.x) %>%
mutate(
cum_pass_grade = zoo::rollmean(pos_PASS,2,fill = NA ),
cum_recv_grade = cummean(l_recv),
cum_pblk_grade = cummean(l_pblk),
cum_run_grade = cummean(l_run),
cum_rblk_grade = cummean(l_rblk)
) %>% ungroup() %>%
mutate(
posid2 = paste0(season,week,posteam.x)
) %>%  #select(posid2,cum_pass_grade,cum_recv_grade,cum_pblk_grade,cum_run_grade,cum_rblk_grade)
select(posid2,posteam.x,pos_PASS,cum_pass_grade)
#pos_cum<-
data %>% group_by(
season,week,posteam.x
) %>% summarise(
posteam.x = unique(posteam.x),
pos_PASS = unique(pos_PASS),
pos_RECV = unique(pos_RECV),
pos_PBLK = unique(pos_PBLK),
pos_RUN = unique(pos_RUN),
pos_RBLK = unique(pos_RBLK)
)%>% arrange(season,posteam.x,week) %>% ungroup() %>%
group_by(season,posteam.x) %>%
ungroup() %>%
mutate(
l_pass=lag(pos_PASS),
l_recv=lag(pos_RECV),
l_pblk=lag(pos_PBLK),
l_run=lag(pos_RUN),
l_rblk=lag(pos_RBLK)) %>%
#filter(!is.na(l_pass)) %>%
group_by(season,posteam.x) %>%
mutate(
cum_pass_grade = zoo::rollmean(pos_PASS,-2,fill = NA ),
cum_recv_grade = cummean(l_recv),
cum_pblk_grade = cummean(l_pblk),
cum_run_grade = cummean(l_run),
cum_rblk_grade = cummean(l_rblk)
) %>% ungroup() %>%
mutate(
posid2 = paste0(season,week,posteam.x)
) %>%  #select(posid2,cum_pass_grade,cum_recv_grade,cum_pblk_grade,cum_run_grade,cum_rblk_grade)
select(posid2,posteam.x,pos_PASS,cum_pass_grade)
#pos_cum<-
data %>% group_by(
season,week,posteam.x
) %>% summarise(
posteam.x = unique(posteam.x),
pos_PASS = unique(pos_PASS),
pos_RECV = unique(pos_RECV),
pos_PBLK = unique(pos_PBLK),
pos_RUN = unique(pos_RUN),
pos_RBLK = unique(pos_RBLK)
)%>% arrange(season,posteam.x,week) %>% ungroup() %>%
group_by(season,posteam.x) %>%
ungroup() %>%
mutate(
l_pass=lag(pos_PASS),
l_recv=lag(pos_RECV),
l_pblk=lag(pos_PBLK),
l_run=lag(pos_RUN),
l_rblk=lag(pos_RBLK)) %>%
#filter(!is.na(l_pass)) %>%
group_by(season,posteam.x) %>%
mutate(
cum_pass_grade = zoo::rollmean(pos_PASS,2,fill = NA ),
cum_recv_grade = cummean(l_recv),
cum_pblk_grade = cummean(l_pblk),
cum_run_grade = cummean(l_run),
cum_rblk_grade = cummean(l_rblk)
) %>% ungroup() %>%
mutate(
posid2 = paste0(season,week,posteam.x)
) %>%  #select(posid2,cum_pass_grade,cum_recv_grade,cum_pblk_grade,cum_run_grade,cum_rblk_grade)
select(posid2,posteam.x,pos_PASS,cum_pass_grade)
#pos_cum<-
data %>% group_by(
season,week,posteam.x
) %>% summarise(
posteam.x = unique(posteam.x),
pos_PASS = unique(pos_PASS),
pos_RECV = unique(pos_RECV),
pos_PBLK = unique(pos_PBLK),
pos_RUN = unique(pos_RUN),
pos_RBLK = unique(pos_RBLK)
)%>% arrange(season,posteam.x,week) %>% ungroup() %>%
group_by(season,posteam.x) %>%
ungroup() %>%
mutate(
l_pass=lag(pos_PASS),
l_recv=lag(pos_RECV),
l_pblk=lag(pos_PBLK),
l_run=lag(pos_RUN),
l_rblk=lag(pos_RBLK)) %>%
#filter(!is.na(l_pass)) %>%
group_by(season,posteam.x) %>%
mutate(
cum_pass_grade = zoo::rollmean(pos_PASS,2,fill = NA ),
cum_recv_grade = cummean(l_recv),
cum_pblk_grade = cummean(l_pblk),
cum_run_grade = cummean(l_run),
cum_rblk_grade = cummean(l_rblk)
) %>% ungroup() %>%
mutate(
posid2 = paste0(season,week,posteam.x)
) %>%  #select(posid2,cum_pass_grade,cum_recv_grade,cum_pblk_grade,cum_run_grade,cum_rblk_grade)
select(posid2,posteam.x,pos_PASS,cum_pass_grade)
library(pracma)
install.packages("pracma")
library(pracma)
#pos_cum<-
data %>% group_by(
season,week,posteam.x
) %>% summarise(
posteam.x = unique(posteam.x),
pos_PASS = unique(pos_PASS),
pos_RECV = unique(pos_RECV),
pos_PBLK = unique(pos_PBLK),
pos_RUN = unique(pos_RUN),
pos_RBLK = unique(pos_RBLK)
)%>% arrange(season,posteam.x,week) %>% ungroup() %>%
group_by(season,posteam.x) %>%
ungroup() %>%
mutate(
l_pass=lag(pos_PASS),
l_recv=lag(pos_RECV),
l_pblk=lag(pos_PBLK),
l_run=lag(pos_RUN),
l_rblk=lag(pos_RBLK)) %>%
#filter(!is.na(l_pass)) %>%
group_by(season,posteam.x) %>%
mutate(
cum_pass_grade = pracma::movavg(pos_PASS, 2, type="s")
cum_recv_grade = cummean(l_recv),
cum_pblk_grade = cummean(l_pblk),
cum_run_grade = cummean(l_run),
cum_rblk_grade = cummean(l_rblk)
) %>% ungroup() %>%
mutate(
posid2 = paste0(season,week,posteam.x)
) %>%  #select(posid2,cum_pass_grade,cum_recv_grade,cum_pblk_grade,cum_run_grade,cum_rblk_grade)
select(posid2,posteam.x,pos_PASS,cum_pass_grade)
#pos_cum<-
data %>% group_by(
season,week,posteam.x
) %>% summarise(
posteam.x = unique(posteam.x),
pos_PASS = unique(pos_PASS),
pos_RECV = unique(pos_RECV),
pos_PBLK = unique(pos_PBLK),
pos_RUN = unique(pos_RUN),
pos_RBLK = unique(pos_RBLK)
)%>% arrange(season,posteam.x,week) %>% ungroup() %>%
group_by(season,posteam.x) %>%
ungroup() %>%
mutate(
l_pass=lag(pos_PASS),
l_recv=lag(pos_RECV),
l_pblk=lag(pos_PBLK),
l_run=lag(pos_RUN),
l_rblk=lag(pos_RBLK)) %>%
#filter(!is.na(l_pass)) %>%
group_by(season,posteam.x) %>%
mutate(
cum_pass_grade = pracma::movavg(pos_PASS, 2, type="s"),
cum_recv_grade = cummean(l_recv),
cum_pblk_grade = cummean(l_pblk),
cum_run_grade = cummean(l_run),
cum_rblk_grade = cummean(l_rblk)
) %>% ungroup() %>%
mutate(
posid2 = paste0(season,week,posteam.x)
) %>%  #select(posid2,cum_pass_grade,cum_recv_grade,cum_pblk_grade,cum_run_grade,cum_rblk_grade)
select(posid2,posteam.x,pos_PASS,cum_pass_grade)
#pos_cum<-
data %>% group_by(
season,week,posteam.x
) %>% summarise(
posteam.x = unique(posteam.x),
pos_PASS = unique(pos_PASS),
pos_RECV = unique(pos_RECV),
pos_PBLK = unique(pos_PBLK),
pos_RUN = unique(pos_RUN),
pos_RBLK = unique(pos_RBLK)
)%>% arrange(season,posteam.x,week) %>% ungroup() %>%
group_by(season,posteam.x) %>%
ungroup() %>%
mutate(
l_pass=lag(pos_PASS),
l_recv=lag(pos_RECV),
l_pblk=lag(pos_PBLK),
l_run=lag(pos_RUN),
l_rblk=lag(pos_RBLK)) %>%
#filter(!is.na(l_pass)) %>%
group_by(season,posteam.x) %>%
mutate(
cum_pass_grade = pracma::movavg(l_pass, 2, type="s"),
cum_recv_grade = cummean(l_recv),
cum_pblk_grade = cummean(l_pblk),
cum_run_grade = cummean(l_run),
cum_rblk_grade = cummean(l_rblk)
) %>% ungroup() %>%
mutate(
posid2 = paste0(season,week,posteam.x)
) %>%  #select(posid2,cum_pass_grade,cum_recv_grade,cum_pblk_grade,cum_run_grade,cum_rblk_grade)
select(posid2,posteam.x,pos_PASS,cum_pass_grade)
install.packages("blogdown")
library(blogdown)
knitr::opts_chunk$set(echo = TRUE)
summary(cars)
plot(pressure)
install.packages("pdflatex")
tinytex::install_tinytex()
print("i")
plot(pressure)
plot(pressure)
# Mixed model -------------------------------------------------------------
sample = readRDS('approach2/sample1.rds')
mixed_model<-sample %>%
lmer(formula=
epa ~
wind +
(1|def_team)
,
control=lmerControl(optimizer="nloptwrap", calc.derivs = FALSE))
#Summary
mixed_model %>% summary()
getME(mixed_model, "theta")
library(lme4)
library(dplyr)
library(plyr)
library(purrr)
library(ggplot2)
#library(ggthemes)
#library(RColorBrewer)
#library(extrafont)
#loadfonts(device = "win")
library(parallel)
# Mixed model -------------------------------------------------------------
sample = readRDS('approach2/sample1.rds')
source('~/GitHub/mixed_effects_bootstrapping/script.R')
# Mixed model -------------------------------------------------------------
sample = readRDS('approach2/sample1.rds')
setwd("~/GitHub/mixed_effects_bootstrapping")
setwd("~/GitHub/mixed_effects_bootstrapping")
# Mixed model -------------------------------------------------------------
sample = readRDS('approach2/sample1.rds')
mixed_model<-sample %>%
lmer(formula=
epa ~
wind +
(1|def_team)
,
control=lmerControl(optimizer="nloptwrap", calc.derivs = FAHLSE))
mixed_model<-sample %>%
lmer(formula=
epa ~
wind +
(1|def_team)
,
control=lmerControl(optimizer="nloptwrap", calc.derivs = FALSE))
#Summary
mixed_model %>% summary()
getME(mixed_model, "theta")
sampler <- function(dat, clustervar, replace = TRUE, reps = 1) {
cid <- unique(dat[, clustervar[1]])
ncid <- length(cid)
recid <- sample(cid, size = ncid * reps, replace = TRUE)
if (replace) {
rid <- lapply(seq_along(recid), function(i) {
cbind(NewID = i, RowID = sample(which(dat[, clustervar] == recid[i]),
size = length(which(dat[, clustervar] == recid[i])), replace = TRUE))
})
} else {
rid <- lapply(seq_along(recid), function(i) {
cbind(NewID = i, RowID = which(dat[, clustervar] == recid[i]))
})
}
dat <- as.data.frame(do.call(rbind, rid))
dat$Replicate <- factor(cut(dat$NewID, breaks = c(1, ncid * 1:reps), include.lowest = TRUE,
labels = FALSE))
dat$NewID <- factor(dat$NewID)
return(dat)
}
memory.limit()
memory.limit(size=30000)
sample %>% select(epa,wind)
sample %>% select(epa,wind,def_team)
sample<-sample %>% select(epa,wind,def_team)
# index
start_time <- Sys.time();indx <- sampler(sample, "def_team", reps = 300);end_time <- Sys.time();end_time - start_time
# resample
start_time <- Sys.time(); resampled_data <- cbind(indx, sample[indx$RowID, ]);end_time <- Sys.time();end_time - start_time
#Here we are getting coefficients from original model to use as starting point
f <- fixef(mixed_model)
r <- getME(mixed_model, "theta")
f
r
rm(indx)
rm(sample)
clus <- makeCluster(4)
resampled_data
start_time <-Sys.time();clusterExport(clus, c("resampled_data", "f", "r"));end_time <- Sys.time();end_time - start_time
start_time <-Sys.time();clusterEvalQ(clus, require(lme4));end_time <- Sys.time();end_time - start_time
boot_function <- function(i) {
simu <- try(
lmer(
formula=
epa ~
wind +
(1|def_team)
,
data = resampled_data
,
subset = Replicate == i
,
control=lmerControl(optimizer="nloptwrap", calc.derivs = FALSE)
,
start = list(fixef = f, theta = r)
)
,
silent = TRUE)
if (class(simu) == "try-error")
return(simu)
c(fixef(simu), getME(simu, "theta"))
}
f
r
start <- proc.time(); output <- parLapplyLB(clus, X = levels(resampled_data$Replicate), fun = boot_function); end <- proc.time();end-start
#Success rate
success <- sapply(output, is.numeric)
mean(success)
#Stop cluster
stopCluster(clus)
rm(resampled_data)
final <- do.call(cbind, output[success])
final_transposed<-t(final) %>% data.frame()
coefficients <- final_transposed$pos_coach
coefficients
coefficients <- final_transposed$def_coach
coefficients
coefficients <- final_transposed$def_team
coefficients
saveRDS(coefficients,'approach2/defteam1.rds')
plot <- data.frame(coef = readRDS('approach2/defteam1.rds'))
ggplot(plot,aes(x=coef))+
geom_density(alpha=.4)+
theme_bw()+
labs(x='Coefficient', y='Density')
